<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>BEGIBEY ‚Äî –ê–¥–º–∏–Ω–∫–∞</title>
    <link rel="stylesheet" href="/styles.css">
  </head>
  <body>
    <header class="site-header"><div class="container header-inner"><a class="brand" href="/index.html"><span class="brand-mark">üè∏</span><span class="brand-divider"></span><span class="brand-name">BEGIBEY Admin</span></a></div></header>
    <main class="container" style="padding:24px 0">
      <section id="authSection">
        <h2>–í—Ö–æ–¥ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h2>
        <div style="max-width:420px">
          <label>Email<input id="email" type="email" placeholder="admin@example.com"></label>
          <label>–ü–∞—Ä–æ–ª—å<input id="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></label>
          <div style="margin-top:12px"><button id="loginBtn" class="btn primary">–í–æ–π—Ç–∏</button> <button id="logoutBtn" class="btn ghost">–í—ã–π—Ç–∏</button></div>
          <div id="authMsg" style="margin-top:10px"></div>
        </div>
      </section>
      <hr style="margin:24px 0;border:none;border-top:1px solid rgba(255,255,255,.2)">
      <section id="formSection" hidden>
        <h2>–ù–æ–≤—ã–π —Ç–æ–≤–∞—Ä</h2>
        <form id="productForm" style="max-width:640px">
          <label>–ù–∞–∑–≤–∞–Ω–∏–µ<input id="pName" required></label>
          <label>–ë—Ä–µ–Ω–¥<select id="pBrand"><option>Yonex</option><option>Li ning</option><option>Taan</option><option>Victor</option><option>Kumpoo</option></select></label>
          <label>–í–∏–¥ —Å–ø–æ—Ä—Ç–∞<select id="pSport"><option>–ë–∞–¥–º–∏–Ω—Ç–æ–Ω</option><option>–§—É—Ç–±–æ–ª</option><option>–ë–∞—Å–∫–µ—Ç–±–æ–ª</option><option>–¢–µ–Ω–Ω–∏—Å</option><option>–ë–µ–≥</option><option>–§–∏—Ç–Ω–µ—Å</option></select></label>
          <label>–¶–µ–Ω–∞<input id="pPrice" type="number" min="0" required></label>
          <label>–†–µ–π—Ç–∏–Ω–≥<input id="pRating" type="number" min="0" max="5" step="0.1" value="4.5"></label>
          <label class="switch"><input id="pInStock" type="checkbox" checked><span>–í –Ω–∞–ª–∏—á–∏–∏</span></label>
          <label>–§–ª–∞–≥–∏<select id="pFlags" multiple size="3"><option value="is_new">–ù–æ–≤–∏–Ω–∫–∞</option><option value="is_sale">–°–∫–∏–¥–∫–∞</option><option value="recommended">–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º</option></select></label>
          <label>URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è<input id="pImage" placeholder="https://...jpg"></label>
          <div style="margin-top:12px"><button class="btn primary" type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div>
          <div id="formMsg" style="margin-top:10px"></div>
        </form>
      </section>
    </main>
    <script type="module">
      import { loadSupabase } from './supabase.js';
      let supabase = null;
      const authMsg = document.getElementById('authMsg');
      const formSection = document.getElementById('formSection');
      const authSection = document.getElementById('authSection');
      const loginBtn = document.getElementById('loginBtn');
      const logoutBtn = document.getElementById('logoutBtn');

      const ensure = async () => {
        supabase = await loadSupabase();
        if(!supabase){ authMsg.textContent = 'Supabase –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ supabase.config.js'; return; }
        supabase.auth.onAuthStateChange((_e, session) => updateAuth(session));
        const { data: { session } } = await supabase.auth.getSession();
        updateAuth(session);
      };

      function updateAuth(session){
        const user = session?.user;
        if(!user){ formSection.hidden = true; authMsg.textContent = '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã'; return; }
        // fetch is_admin
        supabase.from('profiles').select('is_admin').eq('id', user.id).single().then(({ data }) => {
          const isAdmin = !!data?.is_admin;
          formSection.hidden = !isAdmin;
          authMsg.textContent = isAdmin ? `–í–æ—à–ª–∏ –∫–∞–∫ –∞–¥–º–∏–Ω: ${user.email}` : '–ù–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞';
        });
      }

      loginBtn.addEventListener('click', async () => {
        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value;
        const { error } = await supabase.auth.signInWithPassword({ email, password });
        authMsg.textContent = error ? error.message : '–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω';
      });
      logoutBtn.addEventListener('click', async () => { await supabase.auth.signOut(); authMsg.textContent = '–í—ã—à–ª–∏'; });

      document.getElementById('productForm').addEventListener('submit', async (e)=>{
        e.preventDefault();
        const formMsg = document.getElementById('formMsg');
        const values = {
          name: document.getElementById('pName').value.trim(),
          brand: document.getElementById('pBrand').value,
          sport: document.getElementById('pSport').value,
          price: Number(document.getElementById('pPrice').value),
          rating: Number(document.getElementById('pRating').value||4.5),
          in_stock: document.getElementById('pInStock').checked,
          flags: Array.from(document.getElementById('pFlags').selectedOptions).map(o=>o.value),
          image_url: document.getElementById('pImage').value.trim()||null,
        };
        try{
          const { error } = await supabase.from('products').insert(values);
          if(error) throw error;
          formMsg.textContent = '–¢–æ–≤–∞—Ä —Å–æ–∑–¥–∞–Ω';
          e.target.reset();
        }catch(err){ formMsg.textContent = err.message; }
      });

      ensure();
    </script>
  </body>
  </html>


